<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CODM Score Overlay (OBS Chroma)</title>
  <style>
    :root{
      --green:#00ff00; /* OBS chroma key background */
      --panel:#0f1622;
      --panel2:#131c2a;
      --line:rgba(255,255,255,.14);
      --ink:#eef4ff;
      --muted:#aab6cf;
      --left:#30b4ff;
      --right:#ffd34d;
      --danger:#ff6b6b;
      --shadow:0 12px 28px rgba(0,0,0,.35);
      --radius:14px;
    }

    *{ box-sizing:border-box; }
    html, body{
      margin:0;
      width:100%;
      height:100%;
      overflow:hidden;
      background:var(--green);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--ink);
    }

    body{
      background:var(--green);
    }

    .stage{
      position:relative;
      width:100vw;
      height:100vh;
      background:var(--green);
    }

    /* ===== TOP OVERLAY ===== */
    .scorebar-wrap{
      position:absolute;
      top:14px;
      left:50%;
      transform:translateX(-50%);
      width:min(1180px, 96vw);
      display:flex;
      justify-content:center;
      pointer-events:none; /* overlay itself won't block game view */
      z-index:10;
    }

    .scorebar{
      width:min(1120px, 94vw);
      min-height:108px;
      display:grid;
      grid-template-columns: 1fr auto 1fr;
      align-items:stretch;
      gap:10px;
      padding:8px;
      border-radius:18px;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.14);
      box-shadow: var(--shadow);
      backdrop-filter: blur(3px);
      pointer-events:none;
    }

    .side{
      display:grid;
      grid-template-columns: 1fr auto;
      align-items:center;
      gap:12px;
      min-width:0;
      border-radius:14px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(10,14,20,.9);
      position:relative;
    }

    .side.right{
      grid-template-columns: auto 1fr;
    }

    .side.left::before,
    .side.right::before{
      content:"";
      position:absolute;
      inset:0;
      opacity:.16;
      pointer-events:none;
    }
    .side.left::before{
      background:
        linear-gradient(120deg, rgba(48,180,255,.5), transparent 60%);
    }
    .side.right::before{
      background:
        linear-gradient(240deg, rgba(255,211,77,.7), transparent 60%);
    }

    .team-meta{
      min-width:0;
      padding:12px 14px;
      display:flex;
      flex-direction:column;
      gap:4px;
      z-index:1;
    }

    .side.left .team-meta{
      align-items:flex-start;
      text-align:left;
    }
    .side.right .team-meta{
      align-items:flex-end;
      text-align:right;
    }

    .team-name{
      font-weight:900;
      font-size:20px;
      line-height:1;
      letter-spacing:.04em;
      text-transform:uppercase;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:100%;
      text-shadow:0 1px 10px rgba(0,0,0,.35);
    }

    .team-role{
      font-weight:800;
      font-size:11px;
      letter-spacing:.14em;
      text-transform:uppercase;
      color:var(--muted);
      opacity:.95;
    }

    .team-score{
      min-width:84px;
      align-self:stretch;
      display:grid;
      place-items:center;
      font-weight:1000;
      font-size:52px;
      line-height:1;
      letter-spacing:.02em;
      z-index:1;
      background:rgba(255,255,255,.03);
      border-left:1px solid rgba(255,255,255,.08);
      border-right:1px solid rgba(255,255,255,.08);
      text-shadow:0 2px 12px rgba(0,0,0,.35);
    }

    .side.left .team-score{ color:var(--left); }
    .side.right .team-score{ color:var(--right); }

    .middle{
      min-width:310px;
      display:grid;
      grid-template-rows: auto auto;
      gap:8px;
      align-content:center;
      justify-items:center;
      padding:6px 8px;
      border-radius:14px;
      background:rgba(9,12,18,.92);
      border:1px solid rgba(255,255,255,.1);
      position:relative;
      overflow:hidden;
    }

    .middle::before{
      content:"";
      position:absolute;
      inset:0;
      background:
        radial-gradient(circle at 18% 30%, rgba(48,180,255,.18), transparent 35%),
        radial-gradient(circle at 82% 35%, rgba(255,211,77,.22), transparent 35%);
      pointer-events:none;
    }

    .logo-row{
      position:relative;
      z-index:1;
      display:flex;
      align-items:center;
      gap:10px;
    }

    .photo-slot{
      width:72px;
      height:72px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.16);
      background:
        linear-gradient(135deg, rgba(255,255,255,.05), rgba(255,255,255,.02)),
        #0b1018;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.03);
      overflow:hidden;
      display:grid;
      place-items:center;
      position:relative;
      flex:0 0 auto;
    }

    .photo-slot img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }

    .photo-slot .placeholder{
      width:100%;
      height:100%;
      display:grid;
      place-items:center;
      font-weight:900;
      font-size:20px;
      color:rgba(255,255,255,.75);
      letter-spacing:.08em;
      text-transform:uppercase;
      background:
        radial-gradient(circle at 25% 25%, rgba(255,255,255,.07), transparent 40%),
        linear-gradient(135deg, #131b28, #0a0f17);
    }

    .vs-badge{
      min-width:70px;
      height:40px;
      padding:0 14px;
      border-radius:999px;
      display:grid;
      place-items:center;
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.12);
      font-weight:900;
      letter-spacing:.16em;
      text-transform:uppercase;
      color:#fff;
      font-size:13px;
      text-shadow:0 1px 10px rgba(0,0,0,.4);
    }

    .subtitle{
      position:relative;
      z-index:1;
      display:flex;
      align-items:center;
      gap:10px;
      color:var(--muted);
      font-size:12px;
      font-weight:800;
      letter-spacing:.08em;
      text-transform:uppercase;
    }

    .pill{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);
      color:var(--ink);
      border-radius:999px;
      padding:6px 10px;
      line-height:1;
      font-weight:800;
      letter-spacing:.06em;
    }

    .timer-pill{
      color:#ffcc66;
    }

    /* ===== CONTROL PANEL (hide during live use) ===== */
    .controls{
      position:absolute;
      left:14px;
      bottom:14px;
      width:min(480px, calc(100vw - 28px));
      background:rgba(11,15,22,.92);
      border:1px solid rgba(255,255,255,.12);
      border-radius:16px;
      box-shadow:0 18px 40px rgba(0,0,0,.35);
      backdrop-filter: blur(6px);
      padding:12px;
      z-index:20;
      transition: opacity .18s ease, transform .18s ease;
    }

    .stage.hide-ui .controls{
      opacity:0;
      pointer-events:none;
      transform:translateY(8px);
    }

    .controls h2{
      margin:0 0 10px;
      font-size:14px;
      letter-spacing:.04em;
    }

    .grid{
      display:grid;
      gap:10px;
    }

    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }

    .card{
      background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.08);
      border-radius:12px;
      padding:10px;
    }

    .card h3{
      margin:0 0 8px;
      font-size:12px;
      color:var(--muted);
      letter-spacing:.08em;
      text-transform:uppercase;
    }

    label{
      display:block;
      font-size:11px;
      color:var(--muted);
      margin:6px 0 4px;
      letter-spacing:.04em;
    }

    input[type="text"], input[type="number"]{
      width:100%;
      height:36px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.12);
      background:#0d1320;
      color:var(--ink);
      padding:0 10px;
      font-weight:700;
      outline:none;
    }

    input[type="text"]:focus, input[type="number"]:focus{
      border-color:rgba(255,211,77,.45);
      box-shadow:0 0 0 2px rgba(255,211,77,.10);
    }

    .btn-row{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }

    button{
      appearance:none;
      border:1px solid rgba(255,255,255,.12);
      background:#111a29;
      color:var(--ink);
      border-radius:10px;
      padding:8px 10px;
      min-height:36px;
      font-weight:800;
      font-size:12px;
      cursor:pointer;
      box-shadow:0 8px 20px rgba(0,0,0,.18);
    }

    button:hover{ filter:brightness(1.08); }
    button:active{ transform:translateY(1px); }

    .btn-left{ border-color: rgba(48,180,255,.25); background: rgba(48,180,255,.10); }
    .btn-right{ border-color: rgba(255,211,77,.28); background: rgba(255,211,77,.12); }
    .btn-danger{ border-color: rgba(255,107,107,.35); background: rgba(255,107,107,.12); }
    .btn-ghost{ background: rgba(255,255,255,.03); color:var(--muted); }

    .small{
      font-size:11px;
      color:var(--muted);
      line-height:1.35;
    }

    .kbd{
      display:inline-block;
      min-width:18px;
      text-align:center;
      border:1px solid rgba(255,255,255,.18);
      border-bottom-width:2px;
      border-radius:6px;
      padding:1px 5px;
      background:rgba(255,255,255,.04);
      color:var(--ink);
      font-weight:800;
      font-size:11px;
      margin:0 2px;
    }

    @media (max-width: 900px){
      .scorebar{
        width:98vw;
        gap:6px;
        padding:6px;
      }
      .team-name{ font-size:14px; }
      .team-score{ min-width:58px; font-size:34px; }
      .middle{ min-width:220px; padding:6px; gap:6px; }
      .photo-slot{ width:56px; height:56px; border-radius:10px; }
      .vs-badge{ min-width:54px; height:32px; font-size:11px; padding:0 10px; }
      .subtitle{ font-size:10px; gap:6px; }
      .pill{ padding:5px 8px; }
      .row{ grid-template-columns:1fr; }
      .controls{ width:min(520px, calc(100vw - 20px)); left:10px; bottom:10px; }
    }
  </style>
</head>
<body>
  <div class="stage" id="stage">
    <!-- TOP OVERLAY -->
    <div class="scorebar-wrap">
      <div class="scorebar">
        <!-- LEFT SIDE -->
        <div class="side left">
          <div class="team-meta">
            <div class="team-role" id="leftRole">Defender</div>
            <div class="team-name" id="leftNameDisplay">Team Blue</div>
          </div>
          <div class="team-score" id="leftScoreDisplay">0</div>
        </div>

        <!-- MIDDLE / PHOTOS -->
        <div class="middle">
          <div class="logo-row">
            <div class="photo-slot" id="leftPhotoSlot" title="Left photo">
              <img id="leftPhotoImg" alt="Left photo" style="display:none;" />
              <div class="placeholder" id="leftPhotoPlaceholder">L</div>
            </div>

            <div class="vs-badge" id="centerLabelDisplay">VS</div>

            <div class="photo-slot" id="rightPhotoSlot" title="Right photo">
              <img id="rightPhotoImg" alt="Right photo" style="display:none;" />
              <div class="placeholder" id="rightPhotoPlaceholder">R</div>
            </div>
          </div>

          <div class="subtitle">
            <span class="pill" id="roundDisplay">Round 1</span>
            <span class="pill timer-pill" id="timerDisplay">00:00</span>
          </div>
        </div>

        <!-- RIGHT SIDE -->
        <div class="side right">
          <div class="team-score" id="rightScoreDisplay">0</div>
          <div class="team-meta">
            <div class="team-role" id="rightRole">Attacker</div>
            <div class="team-name" id="rightNameDisplay">Team Yellow</div>
          </div>
        </div>
      </div>
    </div>

    <!-- CONTROL PANEL (hide during live use with H) -->
    <div class="controls" id="controls">
      <h2>Overlay Controls (OBS Chroma Page)</h2>

      <div class="grid">
        <div class="row">
          <div class="card">
            <h3>Left Team</h3>
            <label for="leftNameInput">Team Name</label>
            <input id="leftNameInput" type="text" value="Team Blue" />
            <label for="leftRoleInput">Label</label>
            <input id="leftRoleInput" type="text" value="Defender" />
            <label for="leftScoreInput">Score</label>
            <input id="leftScoreInput" type="number" min="0" step="1" value="0" />
            <label>Photo</label>
            <div class="btn-row">
              <button class="btn-left" id="leftUploadBtn">Upload Left Photo</button>
              <button class="btn-ghost" id="leftClearBtn">Clear</button>
            </div>
          </div>

          <div class="card">
            <h3>Right Team</h3>
            <label for="rightNameInput">Team Name</label>
            <input id="rightNameInput" type="text" value="Team Yellow" />
            <label for="rightRoleInput">Label</label>
            <input id="rightRoleInput" type="text" value="Attacker" />
            <label for="rightScoreInput">Score</label>
            <input id="rightScoreInput" type="number" min="0" step="1" value="0" />
            <label>Photo</label>
            <div class="btn-row">
              <button class="btn-right" id="rightUploadBtn">Upload Right Photo</button>
              <button class="btn-ghost" id="rightClearBtn">Clear</button>
            </div>
          </div>
        </div>

        <div class="card">
          <h3>Center / Match Info</h3>
          <div class="row">
            <div>
              <label for="centerLabelInput">Center Label</label>
              <input id="centerLabelInput" type="text" value="VS" />
            </div>
            <div>
              <label for="roundInput">Round Text</label>
              <input id="roundInput" type="text" value="Round 1" />
            </div>
          </div>
          <label for="timerInput">Timer / Small Text</label>
          <input id="timerInput" type="text" value="00:00" />
          <div class="btn-row" style="margin-top:8px;">
            <button id="swapPhotosBtn">Swap Photos</button>
            <button id="resetScoresBtn" class="btn-danger">Reset Scores</button>
            <button id="resetAllBtn" class="btn-danger">Reset All</button>
            <button id="toggleUiBtn">H • Hide UI</button>
          </div>
        </div>

        <div class="card">
          <h3>Hotkeys</h3>
          <div class="small">
            <span class="kbd">Q</span>/<span class="kbd">A</span> = Left + / - score &nbsp; • &nbsp;
            <span class="kbd">P</span>/<span class="kbd">L</span> = Right + / - score<br/>
            <span class="kbd">R</span> = Reset scores &nbsp; • &nbsp;
            <span class="kbd">H</span> = Hide/show controls<br/>
            Click a photo slot (top) or the upload buttons to replace team logo/photo.<br/>
            Tip: Add this page as OBS Browser Source, then apply Chroma Key (green).
          </div>
        </div>
      </div>

      <!-- hidden file inputs -->
      <input type="file" id="leftFileInput" accept="image/*" hidden />
      <input type="file" id="rightFileInput" accept="image/*" hidden />
    </div>
  </div>

  <script>
    const STORAGE_KEY = "codm_score_overlay_v1";

    const state = {
      leftName: "Team Blue",
      leftRole: "Defender",
      leftScore: 0,
      leftPhoto: "",
      rightName: "Team Yellow",
      rightRole: "Attacker",
      rightScore: 0,
      rightPhoto: "",
      centerLabel: "VS",
      roundText: "Round 1",
      timerText: "00:00",
      hideUI: false
    };

    // Display elements
    const el = {
      stage: document.getElementById("stage"),
      controls: document.getElementById("controls"),

      leftNameDisplay: document.getElementById("leftNameDisplay"),
      leftRole: document.getElementById("leftRole"),
      leftScoreDisplay: document.getElementById("leftScoreDisplay"),
      rightNameDisplay: document.getElementById("rightNameDisplay"),
      rightRole: document.getElementById("rightRole"),
      rightScoreDisplay: document.getElementById("rightScoreDisplay"),

      leftPhotoImg: document.getElementById("leftPhotoImg"),
      leftPhotoPlaceholder: document.getElementById("leftPhotoPlaceholder"),
      rightPhotoImg: document.getElementById("rightPhotoImg"),
      rightPhotoPlaceholder: document.getElementById("rightPhotoPlaceholder"),
      leftPhotoSlot: document.getElementById("leftPhotoSlot"),
      rightPhotoSlot: document.getElementById("rightPhotoSlot"),

      centerLabelDisplay: document.getElementById("centerLabelDisplay"),
      roundDisplay: document.getElementById("roundDisplay"),
      timerDisplay: document.getElementById("timerDisplay"),

      leftNameInput: document.getElementById("leftNameInput"),
      leftRoleInput: document.getElementById("leftRoleInput"),
      leftScoreInput: document.getElementById("leftScoreInput"),
      rightNameInput: document.getElementById("rightNameInput"),
      rightRoleInput: document.getElementById("rightRoleInput"),
      rightScoreInput: document.getElementById("rightScoreInput"),
      centerLabelInput: document.getElementById("centerLabelInput"),
      roundInput: document.getElementById("roundInput"),
      timerInput: document.getElementById("timerInput"),

      leftUploadBtn: document.getElementById("leftUploadBtn"),
      rightUploadBtn: document.getElementById("rightUploadBtn"),
      leftClearBtn: document.getElementById("leftClearBtn"),
      rightClearBtn: document.getElementById("rightClearBtn"),
      swapPhotosBtn: document.getElementById("swapPhotosBtn"),
      resetScoresBtn: document.getElementById("resetScoresBtn"),
      resetAllBtn: document.getElementById("resetAllBtn"),
      toggleUiBtn: document.getElementById("toggleUiBtn"),
      leftFileInput: document.getElementById("leftFileInput"),
      rightFileInput: document.getElementById("rightFileInput"),
    };

    function clampScore(n){
      n = Number(n);
      if (!Number.isFinite(n)) n = 0;
      return Math.max(0, Math.floor(n));
    }

    function saveState(){
      try{
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      }catch(err){
        console.warn("State not saved (localStorage issue):", err);
      }
    }

    function loadState(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        const parsed = JSON.parse(raw);
        Object.assign(state, parsed || {});
        state.leftScore = clampScore(state.leftScore);
        state.rightScore = clampScore(state.rightScore);
      }catch(err){
        console.warn("Failed to load saved state:", err);
      }
    }

    function setImage(side, dataUrl){
      if (side === "left") state.leftPhoto = dataUrl || "";
      if (side === "right") state.rightPhoto = dataUrl || "";
      render();
      saveState();
    }

    function renderImage(imgEl, placeholderEl, dataUrl){
      if (dataUrl){
        imgEl.src = dataUrl;
        imgEl.style.display = "block";
        placeholderEl.style.display = "none";
      } else {
        imgEl.removeAttribute("src");
        imgEl.style.display = "none";
        placeholderEl.style.display = "grid";
      }
    }

    function render(){
      // Displays
      el.leftNameDisplay.textContent = state.leftName || "Team Blue";
      el.leftRole.textContent = state.leftRole || "";
      el.leftScoreDisplay.textContent = String(clampScore(state.leftScore));

      el.rightNameDisplay.textContent = state.rightName || "Team Yellow";
      el.rightRole.textContent = state.rightRole || "";
      el.rightScoreDisplay.textContent = String(clampScore(state.rightScore));

      el.centerLabelDisplay.textContent = (state.centerLabel || "VS").toUpperCase();
      el.roundDisplay.textContent = state.roundText || "";
      el.timerDisplay.textContent = state.timerText || "";

      renderImage(el.leftPhotoImg, el.leftPhotoPlaceholder, state.leftPhoto);
      renderImage(el.rightPhotoImg, el.rightPhotoPlaceholder, state.rightPhoto);

      // Inputs
      el.leftNameInput.value = state.leftName ?? "";
      el.leftRoleInput.value = state.leftRole ?? "";
      el.leftScoreInput.value = clampScore(state.leftScore);
      el.rightNameInput.value = state.rightName ?? "";
      el.rightRoleInput.value = state.rightRole ?? "";
      el.rightScoreInput.value = clampScore(state.rightScore);
      el.centerLabelInput.value = state.centerLabel ?? "";
      el.roundInput.value = state.roundText ?? "";
      el.timerInput.value = state.timerText ?? "";

      el.stage.classList.toggle("hide-ui", !!state.hideUI);
      el.toggleUiBtn.textContent = state.hideUI ? "H • Show UI" : "H • Hide UI";
    }

    function applyInputsToState(){
      state.leftName = el.leftNameInput.value.trim() || "Team Blue";
      state.leftRole = el.leftRoleInput.value.trim();
      state.leftScore = clampScore(el.leftScoreInput.value);

      state.rightName = el.rightNameInput.value.trim() || "Team Yellow";
      state.rightRole = el.rightRoleInput.value.trim();
      state.rightScore = clampScore(el.rightScoreInput.value);

      state.centerLabel = el.centerLabelInput.value.trim() || "VS";
      state.roundText = el.roundInput.value.trim();
      state.timerText = el.timerInput.value.trim();

      render();
      saveState();
    }

    function updateScore(side, delta){
      if (side === "left") state.leftScore = clampScore(state.leftScore + delta);
      if (side === "right") state.rightScore = clampScore(state.rightScore + delta);
      render();
      saveState();
    }

    function resetScores(){
      state.leftScore = 0;
      state.rightScore = 0;
      render();
      saveState();
    }

    function resetAll(){
      state.leftName = "Team Blue";
      state.leftRole = "Defender";
      state.leftScore = 0;
      state.leftPhoto = "";
      state.rightName = "Team Yellow";
      state.rightRole = "Attacker";
      state.rightScore = 0;
      state.rightPhoto = "";
      state.centerLabel = "VS";
      state.roundText = "Round 1";
      state.timerText = "00:00";
      render();
      saveState();
    }

    function toggleUI(){
      state.hideUI = !state.hideUI;
      render();
      saveState();
    }

    function wireTextInputs(){
      [
        el.leftNameInput, el.leftRoleInput, el.leftScoreInput,
        el.rightNameInput, el.rightRoleInput, el.rightScoreInput,
        el.centerLabelInput, el.roundInput, el.timerInput
      ].forEach(input => {
        input.addEventListener("input", applyInputsToState);
        input.addEventListener("change", applyInputsToState);
      });
    }

    function readFileAsDataURL(file){
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(String(reader.result || ""));
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    async function handleFileSelect(side, file){
      if (!file) return;
      if (!file.type || !file.type.startsWith("image/")) return;

      try{
        const dataUrl = await readFileAsDataURL(file);
        setImage(side, dataUrl);
      }catch(err){
        console.error("Failed to load image:", err);
      }
    }

    function wireUploads(){
      el.leftUploadBtn.addEventListener("click", () => el.leftFileInput.click());
      el.rightUploadBtn.addEventListener("click", () => el.rightFileInput.click());

      el.leftFileInput.addEventListener("change", async (e) => {
        const file = e.target.files && e.target.files[0];
        await handleFileSelect("left", file);
        e.target.value = "";
      });

      el.rightFileInput.addEventListener("change", async (e) => {
        const file = e.target.files && e.target.files[0];
        await handleFileSelect("right", file);
        e.target.value = "";
      });

      el.leftClearBtn.addEventListener("click", () => setImage("left", ""));
      el.rightClearBtn.addEventListener("click", () => setImage("right", ""));

      // Clicking top slots also opens file picker
      el.leftPhotoSlot.addEventListener("click", () => el.leftFileInput.click());
      el.rightPhotoSlot.addEventListener("click", () => el.rightFileInput.click());

      // Drag/drop support for photo slots
      [el.leftPhotoSlot, el.rightPhotoSlot].forEach((slot, idx) => {
        const side = idx === 0 ? "left" : "right";

        ["dragenter","dragover"].forEach(evt => {
          slot.addEventListener(evt, (e) => {
            e.preventDefault();
            e.stopPropagation();
            slot.style.outline = "2px solid rgba(255,211,77,.55)";
          });
        });

        ["dragleave","drop"].forEach(evt => {
          slot.addEventListener(evt, (e) => {
            e.preventDefault();
            e.stopPropagation();
            slot.style.outline = "";
          });
        });

        slot.addEventListener("drop", async (e) => {
          const file = e.dataTransfer?.files?.[0];
          await handleFileSelect(side, file);
        });
      });
    }

    function wireButtons(){
      el.swapPhotosBtn.addEventListener("click", () => {
        const tmp = state.leftPhoto;
        state.leftPhoto = state.rightPhoto;
        state.rightPhoto = tmp;
        render();
        saveState();
      });

      el.resetScoresBtn.addEventListener("click", resetScores);
      el.resetAllBtn.addEventListener("click", resetAll);
      el.toggleUiBtn.addEventListener("click", toggleUI);
    }

    function wireKeyboard(){
      window.addEventListener("keydown", (e) => {
        const t = e.target;
        const tag = t?.tagName?.toLowerCase() || "";
        const isTyping = ["input", "textarea", "select"].includes(tag) || t?.isContentEditable;
        const key = e.key.toLowerCase();

        // Allow H even while typing (optional)
        if (key === "h") {
          e.preventDefault();
          toggleUI();
          return;
        }

        if (isTyping) return;

        if (key === "q") { e.preventDefault(); updateScore("left", +1); }
        else if (key === "a") { e.preventDefault(); updateScore("left", -1); }
        else if (key === "p") { e.preventDefault(); updateScore("right", +1); }
        else if (key === "l") { e.preventDefault(); updateScore("right", -1); }
        else if (key === "r") { e.preventDefault(); resetScores(); }
      });
    }

    function applyUrlParams(){
      const params = new URLSearchParams(location.search);

      if (params.get("hideui") === "1") state.hideUI = true;

      const leftName = params.get("left");
      const rightName = params.get("right");
      const leftScore = params.get("ls");
      const rightScore = params.get("rs");
      const round = params.get("round");
      const timer = params.get("timer");
      const center = params.get("center");

      if (leftName) state.leftName = leftName;
      if (rightName) state.rightName = rightName;
      if (leftScore !== null) state.leftScore = clampScore(leftScore);
      if (rightScore !== null) state.rightScore = clampScore(rightScore);
      if (round) state.roundText = round;
      if (timer) state.timerText = timer;
      if (center) state.centerLabel = center;
    }

    function init(){
      loadState();
      applyUrlParams();
      wireTextInputs();
      wireUploads();
      wireButtons();
      wireKeyboard();
      render();
    }

    init();
  </script>
</body>
</html>
