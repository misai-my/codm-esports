<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>COD:M Esports Match Results — Overview</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <style>
    :root{
      --bg:#05060a;
      --panel:#0d1017;
      --panel2:#151b26;
      --panel3:#111624;
      --ink:#f6f7fb;
      --muted:#a3acc3;
      --brand:#ffe93b;
      --accent:#7fd2ff;
      --line:#252b3b;
      --danger:#ff6b6b;
      --radius-lg:16px;
      --radius-sm:10px;
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html,body{
      height:100%;
      background:radial-gradient(circle at top,#171c30 0,#05060a 55%);
      color:var(--ink);
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"SF Pro Text",Segoe UI,Roboto,sans-serif;
    }
    body{
      display:flex;
      justify-content:center;
      padding:16px;
    }

    .app{
      width:100%;
      max-width:1280px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    header{
      padding:12px 18px;
      border-radius:var(--radius-lg);
      background:linear-gradient(135deg,#171c30,#111524);
      border:1px solid var(--line);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
    }
    header h1{
      font-size:1.15rem;
      letter-spacing:.06em;
      text-transform:uppercase;
    }
    header span.sub{
      display:block;
      font-size:.8rem;
      color:var(--muted);
      margin-top:2px;
    }

    /* FILTERS */
    section#controls{
      border-radius:var(--radius-lg);
      background:var(--panel);
      border:1px solid var(--line);
      padding:12px 14px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .controls-row{
      display:flex;
      flex-wrap:wrap;
      align-items:flex-end;
      gap:14px;
    }

    .controls-row.bottom{
      margin-top:2px;
    }

    .filter-group{
      display:flex;
      flex-direction:column;
      gap:4px;
      font-size:.8rem;
      min-width:140px;
    }
    .filter-group label{
      color:var(--muted);
    }
    .filter-group select,
    .filter-group input{
      background:var(--panel3);
      border-radius:999px;
      border:1px solid var(--line);
      color:var(--ink);
      padding:6px 10px;
      font-size:.82rem;
      outline:none;
      min-width:0;
    }
    .filter-group select:focus,
    .filter-group input:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 1px rgba(127,210,255,.32);
    }

    .filter-group.wide{
      flex:1 1 220px;
    }

    .summary-line{
      font-size:.78rem;
      color:var(--muted);
      padding-top:4px;
      border-top:1px dashed rgba(255,255,255,.08);
      margin-top:4px;
    }
    .summary-line strong{
      color:var(--brand);
      font-weight:600;
    }

    /* TABLE WRAPPER */
    section#results{
      border-radius:var(--radius-lg);
      background:var(--panel);
      border:1px solid var(--line);
      padding:10px;
    }
    #results h2{
      font-size:.9rem;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:var(--muted);
      margin-bottom:6px;
    }

    .table-scroll{
      max-height:520px;
      overflow:auto;
      border-radius:var(--radius-sm);
      background:var(--panel2);
      border:1px solid var(--line);
    }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:.78rem;
    }
    thead{
      position:sticky;
      top:0;
      z-index:1;
      background:linear-gradient(180deg,#171d2b,#111624);
    }
    th,td{
      padding:6px 8px;
      border-bottom:1px solid rgba(255,255,255,.04);
      white-space:nowrap;
    }
    th{
      text-align:left;
      color:var(--muted);
      font-weight:500;
      font-size:.76rem;
    }
    th.num,td.num{
      text-align:right;
      font-variant-numeric:tabular-nums;
    }
    tbody tr:nth-child(even){
      background:rgba(0,0,0,.18);
    }
    tbody tr:hover{
      background:rgba(127,210,255,.11);
    }
    td.rank{
      color:var(--muted);
      font-weight:500;
    }
    td.team{
      max-width:220px;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    td.team strong{
      font-weight:600;
    }
    .tag-pill{
      display:inline-flex;
      align-items:center;
      padding:2px 6px;
      border-radius:999px;
      font-size:.7rem;
      background:rgba(255,233,59,.16);
      color:var(--brand);
      margin-left:4px;
    }

    .empty{
      padding:10px;
      font-size:.8rem;
      color:var(--muted);
    }

    footer{
      font-size:.7rem;
      color:var(--muted);
      text-align:right;
      padding:2px 4px;
    }

    @media(max-width:800px){
      header{
        align-items:flex-start;
      }
      .filter-group{
        min-width:130px;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>Match Results — Team Overview</h1>
        <span class="sub">Pulling live data from <code>match_results</code> in Supabase</span>
      </div>
    </header>

    <!-- FILTERS -->
    <section id="controls">
      <!-- top row: tournament + match -->
      <div class="controls-row top">
        <div class="filter-group">
          <label for="tournament-filter">Tournament</label>
          <select id="tournament-filter">
            <option value="all">All tournaments</option>
          </select>
        </div>

        <div class="filter-group">
          <label for="match-filter">Match</label>
          <select id="match-filter">
            <option value="all">All matches</option>
          </select>
        </div>
      </div>

      <!-- summary -->
      <div id="summary" class="summary-line">
        Loading results…
      </div>

      <!-- bottom row: stage + day + team search -->
      <div class="controls-row bottom">
        <div class="filter-group">
          <label for="stage-filter">Stage</label>
          <select id="stage-filter">
            <option value="all">All stages</option>
          </select>
        </div>

        <div class="filter-group">
          <label for="day-filter">Day</label>
          <select id="day-filter">
            <option value="all">All days</option>
          </select>
        </div>

        <div class="filter-group wide">
          <label for="team-search">Team search</label>
          <input id="team-search" type="text" placeholder="Type team name…"/>
        </div>
      </div>
    </section>

    <!-- RESULTS TABLE -->
    <section id="results">
      <h2>Team standings (by filters)</h2>
      <div class="table-scroll" id="table-wrapper">
        <div class="empty" id="empty-state">Loading data from Supabase…</div>
      </div>
    </section>

    <footer id="footer-note">
      Kills = Eliminations • <strong>Victory</strong> = match win flag • <strong>Placement pts</strong> = points from placement • <strong>Last plc</strong> = placement in latest match_no (within filters)
    </footer>
  </div>

  <!-- Supabase CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ===== Supabase setup =====
    const SUPABASE_URL = 'https://fjdyppkanjnvyscqrfum.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZqZHlwcGthbmpudnlzY3FyZnVtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzNDU1NzIsImV4cCI6MjA3NTkyMTU3Mn0.ssEN7uA9BVm9AkhsjkWxhPzV1-VQVxc4-u7LS2wt4Aw';

    const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ===== DOM refs =====
    const tournamentFilter = document.getElementById('tournament-filter');
    const matchFilter      = document.getElementById('match-filter');
    const stageFilter      = document.getElementById('stage-filter');
    const dayFilter        = document.getElementById('day-filter');
    const teamSearch       = document.getElementById('team-search');
    const summaryEl        = document.getElementById('summary');
    const tableWrapper     = document.getElementById('table-wrapper');

    let allRows = [];   // raw rows from Supabase

    // ===== Fetch data =====
    async function fetchMatchResults(){
      try{
        summaryEl.textContent = 'Loading results from Supabase…';

        const { data, error } = await client
          .from('match_results')
          .select('*')
          .order('id', { ascending: true });

        if(error){
          console.error('Supabase error:', error);
          summaryEl.textContent = 'Error loading data from Supabase.';
          tableWrapper.innerHTML =
            `<div class="empty">Error loading data: ${error.message}</div>`;
          return;
        }

        allRows = data || [];
        buildFilterOptions();
        applyFiltersAndRender();
      }catch(err){
        console.error('Unexpected error:', err);
        summaryEl.textContent = 'Unexpected error loading data.';
        tableWrapper.innerHTML =
          `<div class="empty">Unexpected error: ${err.message || err}</div>`;
      }
    }

    // ===== Build filter dropdowns =====
    function buildFilterOptions(){
      const tournaments = new Set();
      const matches     = new Set();
      const stages      = new Set();
      const days        = new Set();

      allRows.forEach(r => {
        if(r.tournament) tournaments.add(r.tournament);
        if(r.match_no !== null && r.match_no !== undefined) matches.add(String(r.match_no));
        if(r.stage) stages.add(r.stage);
        if(r.day   !== null && r.day !== undefined) days.add(String(r.day));
      });

      function refillSelect(sel, values, allLabel){
        const current = sel.value;
        sel.innerHTML = '';
        const optAll = document.createElement('option');
        optAll.value = 'all';
        optAll.textContent = allLabel;
        sel.appendChild(optAll);

        Array.from(values)
          .sort((a,b)=>a.localeCompare(b,undefined,{numeric:true}))
          .forEach(v => {
            const opt = document.createElement('option');
            opt.value = v;
            opt.textContent = v;
            sel.appendChild(opt);
          });

        if(current && Array.from(values).includes(current)){
          sel.value = current;
        }else{
          sel.value = 'all';
        }
      }

      refillSelect(tournamentFilter, tournaments, 'All tournaments');
      refillSelect(matchFilter,      matches,     'All matches');
      refillSelect(stageFilter,      stages,      'All stages');
      refillSelect(dayFilter,        days,        'All days');
    }

    // ===== Apply filters and render =====
    function applyFiltersAndRender(){
      const tFilter = tournamentFilter.value;
      const mFilter = matchFilter.value;
      const sFilter = stageFilter.value;
      const dFilter = dayFilter.value;
      const q       = (teamSearch.value || '').trim().toLowerCase();

      const filtered = allRows.filter(r => {
        if(tFilter !== 'all' && r.tournament !== tFilter) return false;
        if(mFilter !== 'all' && String(r.match_no) !== mFilter) return false;
        if(sFilter !== 'all' && r.stage !== sFilter) return false;
        if(dFilter !== 'all' && String(r.day) !== dFilter) return false;
        if(q && !(r.team_name || '').toLowerCase().includes(q)) return false;
        return true;
      });

      renderSummary(filtered);
      renderTable(filtered);
    }

    // ===== Summary line =====
    function renderSummary(rows){
      if(!rows.length){
        summaryEl.innerHTML = 'No rows match the current filters.';
        return;
      }

      const teamMap = new Map();
      const matchSet = new Set();
      let totalVictories = 0;
      let totalElims = 0;
      let totalPoints = 0;

      rows.forEach(r => {
        const key = r.team_name || 'Unknown';
        const current = teamMap.get(key) || { team:key, matches:new Set(), victories:0, eliminations:0, total:0 };
        current.matches.add(r.match_no);
        current.victories += (r.victory ? 1 : 0);
        current.eliminations += (Number(r.elimination)||0);
        current.total += (Number(r.total)||0);
        teamMap.set(key, current);

        matchSet.add(r.match_no);
        totalVictories += (r.victory ? 1 : 0);
        totalElims += (Number(r.elimination)||0);
        totalPoints += (Number(r.total)||0);
      });

      const rowsCount  = rows.length;
      const teamCount  = teamMap.size;
      const matchCount = matchSet.size;

      const tLabel = tournamentFilter.value === 'all'
        ? 'All tournaments'
        : tournamentFilter.value;
      const sLabel = stageFilter.value === 'all'
        ? 'All stages'
        : stageFilter.value;

      summaryEl.innerHTML =
        `<strong>${teamCount}</strong> teams • `+
        `<strong>${matchCount}</strong> matches • `+
        `<strong>${totalVictories}</strong> victories • `+
        `<strong>${totalElims}</strong> eliminations • `+
        `<strong>${totalPoints}</strong> total points • `+
        `Tournament: <strong>${tLabel}</strong> • Stage: <strong>${sLabel}</strong>`;
    }

    // ===== Build aggregated table =====
    function renderTable(rows){
      if(!rows.length){
        tableWrapper.innerHTML =
          '<div class="empty">No data for the selected filters. Try a different tournament, match, stage, day, or team search.</div>';
        return;
      }

      const teamMap = new Map();

      rows.forEach(r => {
        const key = r.team_name || 'Unknown';
        const existing = teamMap.get(key) || {
          team: key,
          matches: new Set(),
          victories: 0,
          eliminations: 0,
          total: 0,
          placementPts: 0,
          lastMatchNo: null,
          lastPlacement: null,
          tournaments: new Set()
        };

        existing.matches.add(r.match_no);
        existing.victories += (r.victory ? 1 : 0);
        existing.eliminations += (Number(r.elimination) || 0);
        existing.total += (Number(r.total) || 0);
        existing.placementPts += (Number(r.placement_pts) || 0);

        // Track last match placement based on highest match_no in filtered rows
        const mNoRaw = r.match_no;
        if(mNoRaw !== null && mNoRaw !== undefined){
          const mNo = Number(mNoRaw);
          if(!Number.isNaN(mNo)){
            if(existing.lastMatchNo === null || mNo > existing.lastMatchNo){
              existing.lastMatchNo = mNo;
              const plc = Number(r.placement);
              existing.lastPlacement = Number.isNaN(plc) ? null : plc;
            }
          }
        }

        if(r.tournament){
          existing.tournaments.add(r.tournament);
        }

        teamMap.set(key, existing);
      });

      let teams = Array.from(teamMap.values()).map(t => ({
        ...t,
        matchesPlayed: t.matches.size,
        tournamentLabel: Array.from(t.tournaments).join(', ')
      }));

      // SORT:
      // Total desc, Victory desc, Elimination desc, Placement pts desc, Last placement asc
      teams.sort((a,b) => {
        if(b.total !== a.total) return b.total - a.total;
        if(b.victories !== a.victories) return b.victories - a.victories;
        if(b.eliminations !== a.eliminations) return b.eliminations - a.eliminations;
        const apPts = a.placementPts || 0;
        const bpPts = b.placementPts || 0;
        if(bpPts !== apPts) return bpPts - apPts;

        const apLast = (a.lastPlacement === null ? Number.POSITIVE_INFINITY : a.lastPlacement);
        const bpLast = (b.lastPlacement === null ? Number.POSITIVE_INFINITY : b.lastPlacement);
        return apLast - bpLast; // ascending last placement (1st is best)
      });

      const rowsHtml = [];

      rowsHtml.push('<table>');
      rowsHtml.push('<thead><tr>'+
        '<th class="num">#</th>'+
        '<th>Team</th>'+
        '<th class="num">Matches</th>'+
        '<th class="num">Victories</th>'+
        '<th class="num">Placement&nbsp;pts</th>'+
        '<th class="num">Last&nbsp;plc</th>'+
        '<th class="num">Elims</th>'+
        '<th class="num">Total</th>'+
        '</tr></thead><tbody>');

      teams.forEach((t, idx) => {
        rowsHtml.push('<tr>'+
          `<td class="num rank">${idx+1}</td>`+
          `<td class="team"><strong>${escapeHtml(t.team)}</strong>`+
          (t.victories > 0 ? `<span class="tag-pill">${t.victories} Victory${t.victories>1?'ies':''}</span>` : '')+
          '</td>'+
          `<td class="num">${t.matchesPlayed}</td>`+
          `<td class="num">${t.victories}</td>`+
          `<td class="num">${t.placementPts}</td>`+
          `<td class="num">${t.lastPlacement !== null ? t.lastPlacement : '—'}</td>`+
          `<td class="num">${t.eliminations}</td>`+
          `<td class="num">${t.total}</td>`+
        '</tr>');
      });

      rowsHtml.push('</tbody></table>');
      tableWrapper.innerHTML = rowsHtml.join('');
    }

    // ===== Helpers =====
    function escapeHtml(str){
      return String(str ?? '')
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#39;');
    }

    // ===== Event wiring =====
    tournamentFilter.addEventListener('change', applyFiltersAndRender);
    matchFilter.addEventListener('change', applyFiltersAndRender);
    stageFilter.addEventListener('change', applyFiltersAndRender);
    dayFilter.addEventListener('change', applyFiltersAndRender);
    teamSearch.addEventListener('input', () => {
      applyFiltersAndRender();
    });

    // ===== Init =====
    document.addEventListener('DOMContentLoaded', fetchMatchResults);
  </script>
</body>
</html>
