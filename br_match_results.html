<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>Match Results — Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <style>
    :root{
      --bg:#05060a;
      --panel:#111524;
      --panel2:#181d2f;
      --ink:#f6f7fb;
      --muted:#a3acc3;
      --brand:#ffe93b;
      --accent:#7fd2ff;
      --danger:#ff6b6b;
      --line:#262b3d;
      --radius-lg:16px;
      --radius-sm:10px;
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html,body{
      height:100%;
      background:radial-gradient(circle at top,#171c30 0,#05060a 52%);
      color:var(--ink);
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"SF Pro Text",Segoe UI,Roboto,sans-serif;
    }
    body{
      display:flex;
      justify-content:center;
      padding:16px;
    }

    .app{
      width:100%;
      max-width:1440px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    header{
      padding:12px 18px;
      border-radius:var(--radius-lg);
      background:linear-gradient(135deg,#171c30,#111524);
      border:1px solid var(--line);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
    }
    header h1{
      font-size:1.1rem;
      letter-spacing:.04em;
      text-transform:uppercase;
    }
    header span.sub{
      font-size:.8rem;
      color:var(--muted);
    }

    .header-right{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      justify-content:flex-end;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      padding:3px 8px;
      border-radius:999px;
      background:#0a0c16;
      border:1px solid rgba(255,233,59,.28);
      font-size:.72rem;
      color:var(--muted);
      gap:6px;
    }
    .pill span.dot{
      width:7px;height:7px;border-radius:50%;background:#38d996;
    }

    /* Filters */
    .filters{
      border-radius:var(--radius-lg);
      background:var(--panel);
      border:1px solid var(--line);
      padding:10px 12px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:flex-end;
    }
    .filter-group{
      display:flex;
      flex-direction:column;
      gap:3px;
      min-width:120px;
      flex:1 1 120px;
      font-size:.78rem;
    }
    .filter-group label{
      color:var(--muted);
    }
    .filter-group select,
    .filter-group input{
      background:var(--panel2);
      border-radius:999px;
      border:1px solid var(--line);
      color:var(--ink);
      padding:6px 10px;
      font-size:.8rem;
      outline:none;
    }
    .filter-group select:focus,
    .filter-group input:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 1px rgba(127,210,255,.28);
    }

    .summary-text{
      font-size:.76rem;
      color:var(--muted);
      margin-top:4px;
    }

    /* Layout main */
    main{
      display:grid;
      grid-template-columns:minmax(320px,380px) 1fr;
      gap:12px;
      align-items:flex-start;
    }

    section{
      border-radius:var(--radius-lg);
      background:var(--panel);
      border:1px solid var(--line);
      padding:10px;
      min-height:0;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    section h2{
      font-size:.9rem;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:var(--muted);
      margin-bottom:2px;
    }

    /* Leaderboard */
    .leaderboard-scroll{
      max-height:420px;
      overflow:auto;
      border-radius:var(--radius-sm);
      background:var(--panel2);
      border:1px solid var(--line);
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:.78rem;
    }
    thead{
      position:sticky;
      top:0;
      background:linear-gradient(180deg,#1d2236,#141827);
      z-index:1;
    }
    th,td{
      padding:6px 7px;
      border-bottom:1px solid var(--line);
      text-align:left;
    }
    th{
      color:var(--muted);
      font-weight:500;
      font-size:.74rem;
    }
    tbody tr:nth-child(even){
      background:rgba(0,0,0,.06);
    }
    .col-r{
      text-align:right;
      font-variant-numeric:tabular-nums;
    }
    .team-name{
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:220px;
    }
    .rank-badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:22px;
      height:22px;
      border-radius:999px;
      border:1px solid rgba(255,233,59,.4);
      background:rgba(255,233,59,.1);
      color:var(--brand);
      font-size:.7rem;
      font-weight:600;
    }

    .status-text{
      font-size:.74rem;
      color:var(--muted);
      margin-top:4px;
    }

    /* Results table */
    .results-scroll{
      max-height:520px;
      overflow:auto;
      border-radius:var(--radius-sm);
      background:var(--panel2);
      border:1px solid var(--line);
    }
    .tag-pill{
      display:inline-flex;
      align-items:center;
      padding:2px 6px;
      border-radius:999px;
      font-size:.66rem;
      letter-spacing:.04em;
      text-transform:uppercase;
    }
    .tag-win{
      background:rgba(99, 230, 165, .14);
      color:#7ef9c0;
      border:1px solid rgba(99, 230, 165, .4);
    }
    .tag-loss{
      background:rgba(251, 113, 133, .14);
      color:#ffb4c2;
      border:1px solid rgba(251, 113, 133, .4);
    }

    .empty-state{
      padding:10px;
      font-size:.78rem;
      color:var(--muted);
    }

    @media(max-width:1040px){
      main{
        display:flex;
        flex-direction:column;
      }
    }
    @media(max-width:720px){
      .filters{
        flex-direction:column;
      }
    }
  </style>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>Match Results — Viewer</h1>
        <span class="sub">Pulled live from Supabase <code>match_results</code> table</span>
      </div>
      <div class="header-right">
        <div class="pill">
          <span class="dot"></span>
          <span id="connection-status">Connected to database</span>
        </div>
      </div>
    </header>

    <!-- FILTERS -->
    <section class="filters">
      <div class="filter-group">
        <label for="filter-tournament">Tournament</label>
        <select id="filter-tournament">
          <option value="ALL">All tournaments</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="filter-stage">Stage</label>
        <select id="filter-stage">
          <option value="ALL">All stages</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="filter-day">Day</label>
        <select id="filter-day">
          <option value="ALL">All days</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="filter-match">Match</label>
        <select id="filter-match">
          <option value="ALL">All matches</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="filter-team">Team search</label>
        <input id="filter-team" type="text" placeholder="Type team name…"/>
      </div>
      <div class="filter-group" style="flex:0 0 100%;max-width:none;">
        <span id="summary-text" class="summary-text">Loading data…</span>
      </div>
    </section>

    <main>
      <!-- LEFT: Leaderboard -->
      <section>
        <h2>Leaderboard (By Total Points)</h2>
        <div class="leaderboard-scroll">
          <table>
            <thead>
              <tr>
                <th style="width:36px;">#</th>
                <th>Team</th>
                <th class="col-r">GP</th>
                <th class="col-r">Victories</th>
                <th class="col-r">Avg PLC</th>
                <th class="col-r">Elims</th>
                <th class="col-r">Total</th>
              </tr>
            </thead>
            <tbody id="leaderboard-body"></tbody>
          </table>
        </div>
        <div id="leaderboard-status" class="status-text"></div>
      </section>

      <!-- RIGHT: Match-by-Match results -->
      <section>
        <h2>Match-by-Match Results</h2>
        <div class="results-scroll">
          <table>
            <thead>
              <tr>
                <th style="width:52px;">Day</th>
                <th style="width:60px;">Match</th>
                <th style="width:54px;">Slot</th>
                <th>Tournament</th>
                <th>Stage</th>
                <th>Team</th>
                <th class="col-r">PLC</th>
                <th class="col-r">Elims</th>
                <th style="width:80px;">Result</th>
                <th class="col-r">PLC Pts</th>
                <th class="col-r">Elim Pts</th>
                <th class="col-r">Total</th>
              </tr>
            </thead>
            <tbody id="results-body"></tbody>
          </table>
          <div id="results-empty" class="empty-state" style="display:none;">
            No results match the current filters.
          </div>
        </div>
        <div id="results-status" class="status-text"></div>
      </section>
    </main>
  </div>

  <script>
    // ===== Supabase Setup =====
    const SUPABASE_URL = 'https://fjdyppkanjnvyscqrfum.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZqZHlwcGthbmpudnlzY3FyZnVtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzNDU1NzIsImV4cCI6MjA3NTkyMTU3Mn0.ssEN7uA9BVm9AkhsjkWxhPzV1-VQVxc4-u7LS2wt4Aw';

    const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ===== DOM REFS =====
    const filterTournament = document.getElementById('filter-tournament');
    const filterStage      = document.getElementById('filter-stage');
    const filterDay        = document.getElementById('filter-day');
    const filterMatch      = document.getElementById('filter-match');
    const filterTeam       = document.getElementById('filter-team');

    const summaryText      = document.getElementById('summary-text');
    const leaderboardBody  = document.getElementById('leaderboard-body');
    const leaderboardStatus= document.getElementById('leaderboard-status');
    const resultsBody      = document.getElementById('results-body');
    const resultsStatus    = document.getElementById('results-status');
    const resultsEmpty     = document.getElementById('results-empty');

    let allResults = [];

    // ===== UTIL =====
    const toNum = (v, fallback = 0) => {
      const n = Number(v);
      return Number.isNaN(n) ? fallback : n;
    };

    const winVal = (v) =>
      (v === true || v === 1 || v === '1' || v === 'true') ? 1 : 0;

    // Custom sorting for the RESULTS table:
    // Total DESC, Victory DESC, Elimination DESC, Placement ASC
    function sortResultsForDisplay(rows){
      return rows.slice().sort((a, b) => {
        // 1) Total desc (fallback: placement_pts + elimination_pts)
        const totalA = toNum(
          a.total ?? (toNum(a.placement_pts) + toNum(a.elimination_pts))
        );
        const totalB = toNum(
          b.total ?? (toNum(b.placement_pts) + toNum(b.elimination_pts))
        );
        if (totalB !== totalA) return totalB - totalA;

        // 2) Victory desc
        const winA = winVal(a.victory);
        const winB = winVal(b.victory);
        if (winB !== winA) return winB - winA;

        // 3) Elimination desc
        const elimA = toNum(a.elimination);
        const elimB = toNum(b.elimination);
        if (elimB !== elimA) return elimB - elimA;

        // 4) Placement asc (1 is best)
        const plcA = toNum(a.placement, 999);
        const plcB = toNum(b.placement, 999);
        if (plcA !== plcB) return plcA - plcB;

        // Fallback: Day → Match → Slot → Team
        const dayA = toNum(a.day, 0);
        const dayB = toNum(b.day, 0);
        if (dayA !== dayB) return dayA - dayB;

        const mA = toNum(a.match_no, 0);
        const mB = toNum(b.match_no, 0);
        if (mA !== mB) return mA - mB;

        const sA = toNum(a.slot, 0);
        const sB = toNum(b.slot, 0);
        if (sA !== sB) return sA - sB;

        const tA = (a.team_name || '').toLowerCase();
        const tB = (b.team_name || '').toLowerCase();
        return tA.localeCompare(tB);
      });
    }

    // ===== LOAD DATA FROM SUPABASE =====
    async function loadMatchResults(){
      summaryText.textContent = 'Loading results from Supabase…';
      leaderboardStatus.textContent = '';
      resultsStatus.textContent = '';

      const { data, error } = await client
        .from('match_results')
        .select('*')
        .order('day', { ascending: true })
        .order('match_no', { ascending: true })
        .order('slot', { ascending: true });

      if(error){
        console.error('Error loading match_results:', error);
        summaryText.textContent = 'Error loading data: ' + error.message;
        leaderboardStatus.textContent = 'Failed to load leaderboard.';
        resultsStatus.textContent = 'Failed to load results.';
        return;
      }

      allResults = data || [];
      buildFilterOptions();
      applyFiltersAndRender();
    }

    // ===== FILTERS =====
    function buildFilterOptions(){
      const tournaments = new Set();
      const stages = new Set();
      const days = new Set();
      const matches = new Set();

      allResults.forEach(r => {
        if(r.tournament) tournaments.add(r.tournament);
        if(r.stage) stages.add(r.stage);
        if(r.day !== null && r.day !== undefined) days.add(r.day);
        if(r.match_no !== null && r.match_no !== undefined) matches.add(r.match_no);
      });

      // Helper to rebuild a select with "ALL" + options
      function rebuildSelect(selectEl, allLabel, values, formatter){
        const current = selectEl.value;
        selectEl.innerHTML = '';
        const optAll = document.createElement('option');
        optAll.value = 'ALL';
        optAll.textContent = allLabel;
        selectEl.appendChild(optAll);

        Array.from(values).sort((a,b) => {
          if(typeof a === 'number' && typeof b === 'number') return a - b;
          return String(a).localeCompare(String(b));
        }).forEach(v => {
          const opt = document.createElement('option');
          opt.value = String(v);
          opt.textContent = formatter ? formatter(v) : String(v);
          selectEl.appendChild(opt);
        });

        // try to keep previous selection if still valid
        if(current && Array.from(selectEl.options).some(o => o.value === current)){
          selectEl.value = current;
        }else{
          selectEl.value = 'ALL';
        }
      }

      rebuildSelect(filterTournament, 'All tournaments', tournaments, v => v);
      rebuildSelect(filterStage, 'All stages', stages, v => v);
      rebuildSelect(filterDay, 'All days', days, v => 'Day ' + v);
      rebuildSelect(filterMatch, 'All matches', matches, v => 'Match ' + v);
    }

    function getFilteredResults(){
      const tVal = filterTournament.value;
      const sVal = filterStage.value;
      const dVal = filterDay.value;
      const mVal = filterMatch.value;
      const teamQuery = filterTeam.value.trim().toLowerCase();

      return allResults.filter(r => {
        if(tVal !== 'ALL' && String(r.tournament || '') !== tVal) return false;
        if(sVal !== 'ALL' && String(r.stage || '') !== sVal) return false;

        if(dVal !== 'ALL'){
          const d = toNum(r.day, null);
          if(String(d) !== dVal) return false;
        }

        if(mVal !== 'ALL'){
          const m = toNum(r.match_no, null);
          if(String(m) !== mVal) return false;
        }

        if(teamQuery){
          const name = (r.team_name || '').toLowerCase();
          if(!name.includes(teamQuery)) return false;
        }

        return true;
      });
    }

    function applyFiltersAndRender(){
      if(!allResults.length){
        summaryText.textContent = 'No data loaded.';
        leaderboardBody.innerHTML = '';
        resultsBody.innerHTML = '';
        leaderboardStatus.textContent = '';
        resultsStatus.textContent = '';
        resultsEmpty.style.display = 'block';
        return;
      }

      const filtered = getFilteredResults();
      const sortedForResults = sortResultsForDisplay(filtered);

      renderSummary(filtered);
      renderLeaderboard(filtered);
      renderResultsTable(sortedForResults);
    }

    // ===== SUMMARY =====
    function renderSummary(rows){
      if(!rows.length){
        summaryText.textContent = 'No rows match the current filters.';
        return;
      }

      const uniqueTeams = new Set();
      const uniqueMatches = new Set();
      let totalWins = 0;
      let totalElims = 0;
      let totalPoints = 0;

      rows.forEach(r => {
        if(r.team_name) uniqueTeams.add(r.team_name);
        uniqueMatches.add(`${r.day}|${r.match_no}`);
        totalWins += winVal(r.victory);
        totalElims += toNum(r.elimination);
        totalPoints += toNum(r.total ?? (toNum(r.placement_pts) + toNum(r.elimination_pts)));
      });

      const tLabel = filterTournament.value === 'ALL'
        ? 'All tournaments'
        : filterTournament.value;
      const stageLabel = filterStage.value === 'ALL'
        ? 'All stages'
        : filterStage.value;

      summaryText.textContent =
        `${rows.length} rows • ${uniqueTeams.size} teams • ${uniqueMatches.size} matches • `
        + `${totalWins} victories • ${totalElims} eliminations • ${totalPoints} total points `
        + `• Tournament: ${tLabel} • Stage: ${stageLabel}`;
    }

    // ===== LEADERBOARD =====
    function computeTeamAggregates(rows){
      const map = new Map();

      rows.forEach(r => {
        const name = r.team_name || '(Unnamed)';
        if(!map.has(name)){
          map.set(name, {
            team: name,
            games: 0,
            wins: 0,
            elims: 0,
            totalPoints: 0,
            placementSum: 0
          });
        }
        const s = map.get(name);
        s.games++;
        s.wins += winVal(r.victory);
        s.elims += toNum(r.elimination);
        s.totalPoints += toNum(r.total ?? (toNum(r.placement_pts) + toNum(r.elimination_pts)));
        s.placementSum += toNum(r.placement, 0);
      });

      return Array.from(map.values()).map(s => ({
        ...s,
        avgPlacement: s.games ? (s.placementSum / s.games) : 0
      }));
    }

    function renderLeaderboard(rows){
      leaderboardBody.innerHTML = '';

      if(!rows.length){
        leaderboardStatus.textContent = 'No data for leaderboard.';
        return;
      }

      const stats = computeTeamAggregates(rows);

      stats.sort((a,b) => {
        if(b.totalPoints !== a.totalPoints) return b.totalPoints - a.totalPoints;
        if(b.wins !== a.wins) return b.wins - a.wins;
        if(b.elims !== a.elims) return b.elims - a.elims;
        return a.avgPlacement - b.avgPlacement;
      });

      stats.forEach((s, idx) => {
        const tr = document.createElement('tr');

        const tdRank = document.createElement('td');
        const badge = document.createElement('div');
        badge.className = 'rank-badge';
        badge.textContent = idx + 1;
        tdRank.appendChild(badge);
        tr.appendChild(tdRank);

        const tdTeam = document.createElement('td');
        tdTeam.className = 'team-name';
        tdTeam.textContent = s.team;
        tr.appendChild(tdTeam);

        const tdGames = document.createElement('td');
        tdGames.className = 'col-r';
        tdGames.textContent = s.games;
        tr.appendChild(tdGames);

        const tdWins = document.createElement('td');
        tdWins.className = 'col-r';
        tdWins.textContent = s.wins;
        tr.appendChild(tdWins);

        const tdAvgPlc = document.createElement('td');
        tdAvgPlc.className = 'col-r';
        tdAvgPlc.textContent = s.avgPlacement ? s.avgPlacement.toFixed(2) : '-';
        tr.appendChild(tdAvgPlc);

        const tdElims = document.createElement('td');
        tdElims.className = 'col-r';
        tdElims.textContent = s.elims;
        tr.appendChild(tdElims);

        const tdTotal = document.createElement('td');
        tdTotal.className = 'col-r';
        tdTotal.textContent = s.totalPoints;
        tr.appendChild(tdTotal);

        leaderboardBody.appendChild(tr);
      });

      leaderboardStatus.textContent = `Showing ${stats.length} teams (sorted by Total, Victories, Elims, Avg Placement).`;
    }

    // ===== RESULTS TABLE =====
    function renderResultsTable(rows){
      resultsBody.innerHTML = '';

      if(!rows.length){
        resultsEmpty.style.display = 'block';
        resultsStatus.textContent = 'No rows match the current filters.';
        return;
      }
      resultsEmpty.style.display = 'none';

      rows.forEach(r => {
        const tr = document.createElement('tr');

        const tdDay = document.createElement('td');
        tdDay.textContent = r.day ?? '';
        tr.appendChild(tdDay);

        const tdMatch = document.createElement('td');
        tdMatch.textContent = r.match_no ?? '';
        tr.appendChild(tdMatch);

        const tdSlot = document.createElement('td');
        tdSlot.textContent = r.slot ?? '';
        tr.appendChild(tdSlot);

        const tdTourn = document.createElement('td');
        tdTourn.textContent = r.tournament || '';
        tr.appendChild(tdTourn);

        const tdStage = document.createElement('td');
        tdStage.textContent = r.stage || '';
        tr.appendChild(tdStage);

        const tdTeam = document.createElement('td');
        tdTeam.textContent = r.team_name || '';
        tr.appendChild(tdTeam);

        const tdPlc = document.createElement('td');
        tdPlc.className = 'col-r';
        tdPlc.textContent = r.placement ?? '';
        tr.appendChild(tdPlc);

        const tdElims = document.createElement('td');
        tdElims.className = 'col-r';
        tdElims.textContent = r.elimination ?? 0;
        tr.appendChild(tdElims);

        const tdResult = document.createElement('td');
        const tag = document.createElement('span');
        tag.classList.add('tag-pill');
        if(winVal(r.victory)){
          tag.classList.add('tag-win');
          tag.textContent = 'Victory';
        }else{
          tag.classList.add('tag-loss');
          tag.textContent = 'No Victory';
        }
        tdResult.appendChild(tag);
        tr.appendChild(tdResult);

        const plcPts = r.placement_pts ?? (r.total - r.elimination_pts);
        const tdPlcPts = document.createElement('td');
        tdPlcPts.className = 'col-r';
        tdPlcPts.textContent = toNum(plcPts,0);
        tr.appendChild(tdPlcPts);

        const elimPts = r.elimination_pts ?? 0;
        const tdElimPts = document.createElement('td');
        tdElimPts.className = 'col-r';
        tdElimPts.textContent = toNum(elimPts,0);
        tr.appendChild(tdElimPts);

        const total = r.total ?? (toNum(plcPts,0) + toNum(elimPts,0));
        const tdTotal = document.createElement('td');
        tdTotal.className = 'col-r';
        tdTotal.textContent = total;
        tr.appendChild(tdTotal);

        resultsBody.appendChild(tr);
      });

      resultsStatus.textContent = `Showing ${rows.length} rows, sorted by Total, Victory, Elims, then Placement.`;
    }

    // ===== EVENT HOOKS =====
    filterTournament.addEventListener('change', applyFiltersAndRender);
    filterStage.addEventListener('change', applyFiltersAndRender);
    filterDay.addEventListener('change', applyFiltersAndRender);
    filterMatch.addEventListener('change', applyFiltersAndRender);
    filterTeam.addEventListener('input', () => {
      // small debounce could be added; for now just filter
      applyFiltersAndRender();
    });

    // ===== INIT =====
    document.addEventListener('DOMContentLoaded', () => {
      loadMatchResults();
    });
  </script>
</body>
</html>
