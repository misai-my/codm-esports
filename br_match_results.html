<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>Match Results — Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <style>
    :root{
      --bg:#05060a;
      --panel:#111524;
      --panel2:#181d2f;
      --ink:#f6f7fb;
      --muted:#a3acc3;
      --brand:#ffe93b;
      --accent:#7fd2ff;
      --line:#262b3d;
      --radius-lg:16px;
      --radius-sm:10px;
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html,body{
      height:100%;
      background:radial-gradient(circle at top,#171c30 0,#05060a 52%);
      color:var(--ink);
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"SF Pro Text",Segoe UI,Roboto,sans-serif;
    }
    body{
      display:flex;
      justify-content:center;
      padding:16px;
    }

    .app{
      width:100%;
      max-width:1440px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    header{
      padding:12px 18px;
      border-radius:var(--radius-lg);
      background:linear-gradient(135deg,#171c30,#111524);
      border:1px solid var(--line);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    header h1{
      font-size:1.1rem;
      letter-spacing:.04em;
      text-transform:uppercase;
    }
    header span.sub{
      font-size:.8rem;
      color:var(--muted);
    }

    .header-right{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      padding:3px 8px;
      border-radius:999px;
      background:#0a0c16;
      border:1px solid rgba(255,233,59,.28);
      font-size:.72rem;
      color:var(--muted);
      gap:6px;
    }
    .pill span.dot{
      width:7px;height:7px;border-radius:50%;background:#38d996;
    }

    /* Filters */
    .filters{
      border-radius:var(--radius-lg);
      background:var(--panel);
      border:1px solid var(--line);
      padding:8px 10px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:flex-end;
    }
    .filter-group{
      display:flex;
      flex-direction:column;
      gap:3px;
      min-width:120px;
      flex:1 1 120px;
      font-size:.78rem;
    }
    .filter-group label{
      color:var(--muted);
    }
    .filter-group select,
    .filter-group input{
      background:var(--panel2);
      border-radius:999px;
      border:1px solid var(--line);
      color:var(--ink);
      padding:6px 10px;
      font-size:.8rem;
      outline:none;
    }
    .filter-group select:focus,
    .filter-group input:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 1px rgba(127,210,255,.28);
    }
    .summary-text{
      font-size:.76rem;
      color:var(--muted);
      margin-top:2px;
    }

    /* Results card */
    section{
      border-radius:var(--radius-lg);
      background:var(--panel);
      border:1px solid var(--line);
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:6px;
      min-height:0;
    }
    section h2{
      font-size:.9rem;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:var(--muted);
      margin-bottom:2px;
    }

    .results-scroll{
      max-height:540px;
      overflow:auto;
      border-radius:var(--radius-sm);
      background:var(--panel2);
      border:1px solid var(--line);
    }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:.78rem;
    }
    thead{
      position:sticky;
      top:0;
      background:linear-gradient(180deg,#1d2236,#141827);
      z-index:1;
    }
    th,td{
      padding:6px 7px;
      border-bottom:1px solid var(--line);
      text-align:left;
    }
    th{
      color:var(--muted);
      font-weight:500;
      font-size:.74rem;
      white-space:nowrap;
    }
    tbody tr:nth-child(even){
      background:rgba(0,0,0,.06);
    }
    .col-r{
      text-align:right;
      font-variant-numeric:tabular-nums;
    }
    .team-name{
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:220px;
    }

    .tag-pill{
      display:inline-flex;
      align-items:center;
      padding:2px 6px;
      border-radius:999px;
      font-size:.66rem;
      letter-spacing:.04em;
      text-transform:uppercase;
    }
    .tag-win{
      background:rgba(99, 230, 165, .14);
      color:#7ef9c0;
      border:1px solid rgba(99, 230, 165, .4);
    }
    .tag-loss{
      background:rgba(251, 113, 133, .14);
      color:#ffb4c2;
      border:1px solid rgba(251, 113, 133, .4);
    }

    .empty-state{
      padding:10px;
      font-size:.78rem;
      color:var(--muted);
    }
    .status-text{
      font-size:.74rem;
      color:var(--muted);
      margin-top:2px;
    }

    @media(max-width:720px){
      .filters{
        flex-direction:column;
      }
    }
  </style>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>Match Results — Viewer</h1>
        <span class="sub">Pulling from Supabase <code>match_results</code></span>
      </div>
      <div class="header-right">
        <div class="pill">
          <span class="dot"></span>
          <span id="connection-status">Connected</span>
        </div>
      </div>
    </header>

    <!-- FILTERS -->
    <section class="filters">
      <div class="filter-group">
        <label for="filter-tournament">Tournament</label>
        <select id="filter-tournament">
          <option value="ALL">All tournaments</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="filter-stage">Stage</label>
        <select id="filter-stage">
          <option value="ALL">All stages</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="filter-day">Day</label>
        <select id="filter-day">
          <option value="ALL">All days</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="filter-match">Match</label>
        <select id="filter-match">
          <option value="ALL">All matches</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="filter-team">Team search</label>
        <input id="filter-team" type="text" placeholder="Type team name…"/>
      </div>
      <div class="filter-group" style="flex:0 0 100%;max-width:none;">
        <span id="summary-text" class="summary-text">Loading data…</span>
      </div>
    </section>

    <!-- RESULTS -->
    <section>
      <h2>Results (sorted by Total, Victory, Elims, Placement)</h2>
      <div class="results-scroll">
        <table>
          <thead>
            <tr>
              <th style="width:54px;">Day</th>
              <th style="width:70px;">Stage</th>
              <th style="width:56px;">Match</th>
              <th style="width:52px;">Slot</th>
              <th>Tournament</th>
              <th>Team</th>
              <th class="col-r">Placement</th>
              <th class="col-r">Elims</th>
              <th style="width:86px;">Victory</th>
              <th class="col-r">PLC Pts</th>
              <th class="col-r">Elim Pts</th>
              <th class="col-r">Total</th>
            </tr>
          </thead>
          <tbody id="results-body"></tbody>
        </table>
        <div id="results-empty" class="empty-state" style="display:none;">
          No results match the current filters.
        </div>
      </div>
      <div id="results-status" class="status-text"></div>
    </section>
  </div>

  <script>
    // ===== Supabase Setup =====
    const SUPABASE_URL = 'https://fjdyppkanjnvyscqrfum.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZqZHlwcGthbmpudnlzY3FyZnVtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzNDU1NzIsImV4cCI6MjA3NTkyMTU3Mn0.ssEN7uA9BVm9AkhsjkWxhPzV1-VQVxc4-u7LS2wt4Aw';

    const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // DOM refs
    const filterTournament = document.getElementById('filter-tournament');
    const filterStage      = document.getElementById('filter-stage');
    const filterDay        = document.getElementById('filter-day');
    const filterMatch      = document.getElementById('filter-match');
    const filterTeam       = document.getElementById('filter-team');

    const summaryText      = document.getElementById('summary-text');
    const resultsBody      = document.getElementById('results-body');
    const resultsEmpty     = document.getElementById('results-empty');
    const resultsStatus    = document.getElementById('results-status');

    let allResults = [];

    // Helpers
    const toNum = (v, fallback = 0) => {
      const n = Number(v);
      return Number.isNaN(n) ? fallback : n;
    };

    const winVal = (v) =>
      (v === true || v === 1 || v === '1' || v === 'true') ? 1 : 0;

    // Custom sort: Total DESC, Victory DESC, Elims DESC, Placement ASC
    function sortResultsForDisplay(rows){
      return rows.slice().sort((a, b) => {
        // 1) Total points
        const totalA = toNum(
          a.total ?? (toNum(a.placement_pts) + toNum(a.elimination_pts))
        );
        const totalB = toNum(
          b.total ?? (toNum(b.placement_pts) + toNum(b.elimination_pts))
        );
        if (totalB !== totalA) return totalB - totalA;

        // 2) Victory (1 > 0)
        const winA = winVal(a.victory);
        const winB = winVal(b.victory);
        if (winB !== winA) return winB - winA;

        // 3) Eliminations
        const elimA = toNum(a.elimination);
        const elimB = toNum(b.elimination);
        if (elimB !== elimA) return elimB - elimA;

        // 4) Placement (1 is better, so ASC)
        const plcA = toNum(a.placement, 999);
        const plcB = toNum(b.placement, 999);
        if (plcA !== plcB) return plcA - plcB;

        // Tie-breakers: Day → Match → Slot → Team name
        const dayA = toNum(a.day, 0);
        const dayB = toNum(b.day, 0);
        if (dayA !== dayB) return dayA - dayB;

        const mA = toNum(a.match_no, 0);
        const mB = toNum(b.match_no, 0);
        if (mA !== mB) return mA - mB;

        const sA = toNum(a.slot, 0);
        const sB = toNum(b.slot, 0);
        if (sA !== sB) return sA - sB;

        const tA = (a.team_name || '').toLowerCase();
        const tB = (b.team_name || '').toLowerCase();
        return tA.localeCompare(tB);
      });
    }

    // Load from Supabase
    async function loadMatchResults(){
      summaryText.textContent = 'Loading results from Supabase…';
      resultsStatus.textContent = '';

      const { data, error } = await client
        .from('match_results')
        .select('*')
        .order('day', { ascending: true })
        .order('match_no', { ascending: true })
        .order('slot', { ascending: true });

      if(error){
        console.error('Error loading match_results:', error);
        summaryText.textContent = 'Error loading data: ' + error.message;
        resultsStatus.textContent = 'Failed to load results.';
        return;
      }

      allResults = data || [];
      buildFilterOptions();
      applyFiltersAndRender();
    }

    // Build filter options from data
    function buildFilterOptions(){
      const tournaments = new Set();
      const stages = new Set();
      const days = new Set();
      const matches = new Set();

      allResults.forEach(r => {
        if(r.tournament) tournaments.add(r.tournament);
        if(r.stage) stages.add(r.stage);
        if(r.day !== null && r.day !== undefined) days.add(r.day);
        if(r.match_no !== null && r.match_no !== undefined) matches.add(r.match_no);
      });

      function rebuildSelect(selectEl, allLabel, values, formatter){
        const current = selectEl.value;
        selectEl.innerHTML = '';
        const optAll = document.createElement('option');
        optAll.value = 'ALL';
        optAll.textContent = allLabel;
        selectEl.appendChild(optAll);

        Array.from(values).sort((a,b) => {
          if(typeof a === 'number' && typeof b === 'number') return a - b;
          return String(a).localeCompare(String(b));
        }).forEach(v => {
          const opt = document.createElement('option');
          opt.value = String(v);
          opt.textContent = formatter ? formatter(v) : String(v);
          selectEl.appendChild(opt);
        });

        if(current && Array.from(selectEl.options).some(o => o.value === current)){
          selectEl.value = current;
        }else{
          selectEl.value = 'ALL';
        }
      }

      rebuildSelect(filterTournament, 'All tournaments', tournaments, v => v);
      rebuildSelect(filterStage, 'All stages', stages, v => v);
      rebuildSelect(filterDay, 'All days', days, v => 'Day ' + v);
      rebuildSelect(filterMatch, 'All matches', matches, v => 'Match ' + v);
    }

    // Filter logic
    function getFilteredResults(){
      const tVal = filterTournament.value;
      const sVal = filterStage.value;
      const dVal = filterDay.value;
      const mVal = filterMatch.value;
      const teamQuery = filterTeam.value.trim().toLowerCase();

      return allResults.filter(r => {
        if(tVal !== 'ALL' && String(r.tournament || '') !== tVal) return false;
        if(sVal !== 'ALL' && String(r.stage || '') !== sVal) return false;

        if(dVal !== 'ALL'){
          const d = toNum(r.day, null);
          if(String(d) !== dVal) return false;
        }

        if(mVal !== 'ALL'){
          const m = toNum(r.match_no, null);
          if(String(m) !== mVal) return false;
        }

        if(teamQuery){
          const name = (r.team_name || '').toLowerCase();
          if(!name.includes(teamQuery)) return false;
        }

        return true;
      });
    }

    function renderSummary(rows){
      if(!rows.length){
        summaryText.textContent = 'No rows match the current filters.';
        return;
      }

      const teamSet = new Set();
      const matchSet = new Set();
      let totalWins = 0;
      let totalElims = 0;
      let totalPoints = 0;

      rows.forEach(r => {
        if(r.team_name) teamSet.add(r.team_name);
        matchSet.add(`${r.day}|${r.match_no}`);
        totalWins += winVal(r.victory);
        totalElims += toNum(r.elimination);
        totalPoints += toNum(
          r.total ?? (toNum(r.placement_pts) + toNum(r.elimination_pts))
        );
      });

      const tLabel = filterTournament.value === 'ALL'
        ? 'All tournaments'
        : filterTournament.value;
      const sLabel = filterStage.value === 'ALL'
        ? 'All stages'
        : filterStage.value;

      summaryText.textContent =
        `${rows.length} rows • ${teamSet.size} teams • ${matchSet.size} matches • `
        + `${totalWins} victories • ${totalElims} eliminations • ${totalPoints} total points `
        + `• Tournament: ${tLabel} • Stage: ${sLabel}`;
    }

    function renderResultsTable(rows){
      resultsBody.innerHTML = '';

      if(!rows.length){
        resultsEmpty.style.display = 'block';
        resultsStatus.textContent = 'No rows match the current filters.';
        return;
      }
      resultsEmpty.style.display = 'none';

      const sorted = sortResultsForDisplay(rows);

      sorted.forEach(r => {
        const tr = document.createElement('tr');

        const tdDay = document.createElement('td');
        tdDay.textContent = r.day ?? '';
        tr.appendChild(tdDay);

        const tdStage = document.createElement('td');
        tdStage.textContent = r.stage || '';
        tr.appendChild(tdStage);

        const tdMatch = document.createElement('td');
        tdMatch.textContent = r.match_no ?? '';
        tr.appendChild(tdMatch);

        const tdSlot = document.createElement('td');
        tdSlot.textContent = r.slot ?? '';
        tr.appendChild(tdSlot);

        const tdTourn = document.createElement('td');
        tdTourn.textContent = r.tournament || '';
        tr.appendChild(tdTourn);

        const tdTeam = document.createElement('td');
        tdTeam.className = 'team-name';
        tdTeam.textContent = r.team_name || '';
        tr.appendChild(tdTeam);

        const tdPlc = document.createElement('td');
        tdPlc.className = 'col-r';
        tdPlc.textContent = r.placement ?? '';
        tr.appendChild(tdPlc);

        const tdElims = document.createElement('td');
        tdElims.className = 'col-r';
        tdElims.textContent = r.elimination ?? 0;
        tr.appendChild(tdElims);

        const tdVictory = document.createElement('td');
        const tag = document.createElement('span');
        tag.classList.add('tag-pill');
        if(winVal(r.victory)){
          tag.classList.add('tag-win');
          tag.textContent = 'Victory';
        }else{
          tag.classList.add('tag-loss');
          tag.textContent = 'No Victory';
        }
        tdVictory.appendChild(tag);
        tr.appendChild(tdVictory);

        const plcPts = r.placement_pts ?? (r.total - r.elimination_pts);
        const tdPlcPts = document.createElement('td');
        tdPlcPts.className = 'col-r';
        tdPlcPts.textContent = toNum(plcPts,0);
        tr.appendChild(tdPlcPts);

        const elimPts = r.elimination_pts ?? 0;
        const tdElimPts = document.createElement('td');
        tdElimPts.className = 'col-r';
        tdElimPts.textContent = toNum(elimPts,0);
        tr.appendChild(tdElimPts);

        const total = r.total ?? (toNum(plcPts,0) + toNum(elimPts,0));
        const tdTotal = document.createElement('td');
        tdTotal.className = 'col-r';
        tdTotal.textContent = total;
        tr.appendChild(tdTotal);

        resultsBody.appendChild(tr);
      });

      resultsStatus.textContent =
        `Showing ${rows.length} rows (sorted by Total, Victory, Elims, Placement).`;
    }

    function applyFiltersAndRender(){
      if(!allResults.length){
        summaryText.textContent = 'No data loaded.';
        resultsBody.innerHTML = '';
        resultsEmpty.style.display = 'block';
        resultsStatus.textContent = '';
        return;
      }
      const filtered = getFilteredResults();
      renderSummary(filtered);
      renderResultsTable(filtered);
    }

    // Events
    filterTournament.addEventListener('change', applyFiltersAndRender);
    filterStage.addEventListener('change', applyFiltersAndRender);
    filterDay.addEventListener('change', applyFiltersAndRender);
    filterMatch.addEventListener('change', applyFiltersAndRender);
    filterTeam.addEventListener('input', () => {
      applyFiltersAndRender();
    });

    // Init
    document.addEventListener('DOMContentLoaded', () => {
      loadMatchResults();
    });
  </script>
</body>
</html>
