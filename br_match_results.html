<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>Tournament Match Results</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <style>
    :root{
      --bg:#05060a;
      --panel:#111524;
      --panel2:#181d2f;
      --ink:#f6f7fb;
      --muted:#a3acc3;
      --brand:#ffe93b;
      --brand-soft:rgba(255,233,59,.14);
      --accent:#7fd2ff;
      --line:#262b3d;
      --radius-lg:16px;
      --radius-sm:8px;
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html,body{
      height:100%;
      background:radial-gradient(circle at top,#171c30 0,#05060a 52%);
      color:var(--ink);
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"SF Pro Text",Segoe UI,Roboto,sans-serif;
    }

    body{
      display:flex;
      justify-content:center;
      padding:16px;
    }

    .app{
      width:100%;
      max-width:1280px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    header{
      padding:12px 18px;
      border-radius:var(--radius-lg);
      background:linear-gradient(135deg,#171c30,#111524);
      border:1px solid var(--line);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
    }
    header h1{
      font-size:1.1rem;
      letter-spacing:.04em;
      text-transform:uppercase;
    }
    header span.sub{
      font-size:.8rem;
      color:var(--muted);
    }

    main{
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    section{
      border-radius:var(--radius-lg);
      background:var(--panel);
      border:1px solid var(--line);
      padding:12px;
    }

    section h2{
      font-size:.9rem;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:var(--muted);
      margin-bottom:8px;
    }

    /* Filters */
    .filters{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:flex-end;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:4px;
      font-size:.82rem;
    }
    .field label{
      color:var(--muted);
      font-size:.74rem;
    }
    .field select,
    .field input[type="text"]{
      background:var(--panel2);
      border-radius:var(--radius-sm);
      border:1px solid var(--line);
      color:var(--ink);
      padding:6px 8px;
      font-size:.82rem;
      outline:none;
      min-width:120px;
    }
    .field select:focus,
    .field input[type="text"]:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 1px rgba(127,210,255,.3);
    }

    .summary{
      margin-top:6px;
      font-size:.78rem;
      color:var(--muted);
    }

    /* Leaderboard */
    .leaderboard-table{
      width:100%;
      border-collapse:collapse;
      font-size:.8rem;
      border-radius:var(--radius-sm);
      overflow:hidden;
      margin-top:4px;
    }
    .leaderboard-table thead{
      background:var(--panel2);
    }
    .leaderboard-table th,
    .leaderboard-table td{
      padding:6px 6px;
      border-bottom:1px solid var(--line);
      text-align:right;
    }
    .leaderboard-table th{
      color:var(--muted);
      font-weight:500;
      font-size:.78rem;
    }
    .leaderboard-table th.team,
    .leaderboard-table td.team{
      text-align:left;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .leaderboard-table th.rank,
    .leaderboard-table td.rank{
      width:40px;
    }
    .leaderboard-table td.total{
      color:var(--brand);
      font-weight:600;
      font-variant-numeric:tabular-nums;
    }
    .leaderboard-table tbody tr:nth-child(even){
      background:rgba(0,0,0,.08);
    }

    .chip-row{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:6px;
      font-size:.72rem;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      padding:2px 6px;
      border-radius:999px;
      background:var(--panel2);
      color:var(--muted);
      border:1px solid rgba(255,255,255,.06);
    }
    .chip strong{
      margin-left:3px;
      color:var(--ink);
    }

    /* Results table */
    .results-wrapper{
      max-height:420px;
      overflow:auto;
      border-radius:var(--radius-sm);
      border:1px solid var(--line);
      background:var(--panel2);
    }
    .results-table{
      width:100%;
      border-collapse:collapse;
      font-size:.78rem;
      min-width:820px;
    }
    .results-table thead{
      position:sticky;
      top:0;
      background:#14192a;
      z-index:1;
    }
    .results-table th,
    .results-table td{
      padding:5px 6px;
      border-bottom:1px solid var(--line);
    }
    .results-table th{
      color:var(--muted);
      font-weight:500;
      text-align:left;
      font-size:.75rem;
      white-space:nowrap;
    }
    .results-table td{
      font-variant-numeric:tabular-nums;
    }
    .results-table td.team{
      font-weight:500;
      color:var(--ink);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .results-table td.victory{
      font-weight:600;
      color:var(--brand);
    }
    .results-table tbody tr:nth-child(even){
      background:rgba(0,0,0,.08);
    }

    .status-text{
      font-size:.76rem;
      color:var(--muted);
      margin-top:4px;
    }

    @media (max-width:768px){
      body{padding:10px;}
      header{padding:10px 12px;}
      section{padding:10px;}
      .results-wrapper{max-height:340px;}
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>Tournament Match Results</h1>
        <span class="sub">Live scoreboard and per-match breakdown from <code>match_results</code></span>
      </div>
      <div style="font-size:.78rem;color:var(--muted);text-align:right;">
        Filter by tournament, stage, day, or team name to see standings.
      </div>
    </header>

    <main>
      <!-- FILTERS -->
      <section>
        <h2>Filters</h2>
        <div class="filters">
          <div class="field">
            <label for="filter-tournament">Tournament</label>
            <select id="filter-tournament">
              <option value="all">All tournaments</option>
            </select>
          </div>

          <div class="field">
            <label for="filter-stage">Stage</label>
            <select id="filter-stage">
              <option value="all">All stages</option>
            </select>
          </div>

          <div class="field">
            <label for="filter-day">Day</label>
            <select id="filter-day">
              <option value="all">All days</option>
            </select>
          </div>

          <div class="field" style="flex:1;min-width:180px;">
            <label for="filter-team">Search Team</label>
            <input type="text" id="filter-team" placeholder="Type part of a team name…"/>
          </div>
        </div>

        <p id="summary-text" class="summary">Loading match data…</p>
      </section>

      <!-- LEADERBOARD -->
      <section>
        <h2>Leaderboard</h2>

        <div class="chip-row" id="summary-chips">
          <!-- chips injected via JS -->
        </div>

        <table class="leaderboard-table">
          <thead>
            <tr>
              <th class="rank">#</th>
              <th class="team">Team</th>
              <th>MP</th>
              <th>Booyah</th>
              <th>PLC Pts</th>
              <th>ELIM Pts</th>
              <th class="total">Total</th>
            </tr>
          </thead>
          <tbody id="leaderboard-body">
            <!-- rows injected via JS -->
          </tbody>
        </table>

        <p id="leaderboard-status" class="status-text"></p>
      </section>

      <!-- FULL RESULTS -->
      <section>
        <h2>Match-by-Match Results</h2>
        <div class="results-wrapper">
          <table class="results-table">
            <thead>
              <tr>
                <th>Day</th>
                <th>Stage</th>
                <th>Tournament</th>
                <th>Match</th>
                <th>Slot</th>
                <th>Team</th>
                <th>PLC</th>
                <th>ELIM</th>
                <th>Victory</th>
                <th>PLC Pts</th>
                <th>ELIM Pts</th>
                <th>Total</th>
              </tr>
            </thead>
            <tbody id="results-body">
              <!-- rows injected via JS -->
            </tbody>
          </table>
        </div>
        <p id="results-status" class="status-text"></p>
      </section>
    </main>
  </div>

  <!-- Supabase CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    // ----- Supabase client -----
    // Using same project as your bracket settings page.
    const SUPABASE_URL = 'https://fjdyppkanjnvyscqrfum.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZqZHlwcGthbmpudnlzY3FyZnVtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzNDU1NzIsImV4cCI6MjA3NTkyMTU3Mn0.ssEN7uA9BVm9AkhsjkWxhPzV1-VQVxc4-u7LS2wt4Aw';

    const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // match_results columns (DB):
    // id, day, stage, match_no, slot, team_name, placement, elimination,
    // victory, placement_pts, elimination_pts, total, tournament

    // ----- State -----
    let allResults = [];

    // DOM refs
    const tournamentSelect = document.getElementById('filter-tournament');
    const stageSelect      = document.getElementById('filter-stage');
    const daySelect        = document.getElementById('filter-day');
    const teamInput        = document.getElementById('filter-team');
    const summaryText      = document.getElementById('summary-text');
    const summaryChips     = document.getElementById('summary-chips');
    const leaderboardBody  = document.getElementById('leaderboard-body');
    const resultsBody      = document.getElementById('results-body');
    const leaderboardStatus = document.getElementById('leaderboard-status');
    const resultsStatus     = document.getElementById('results-status');

    // ----- Helpers -----
    function buildFiltersFromData(){
      const tournaments = Array.from(
        new Set(
          allResults
            .map(r => r.tournament)
            .filter(v => v !== null && v !== undefined && String(v).trim() !== '')
        )
      ).sort((a,b) => String(a).localeCompare(String(b)));

      const stages = Array.from(
        new Set(
          allResults
            .map(r => r.stage)
            .filter(v => v !== null && v !== undefined && String(v).trim() !== '')
        )
      ).sort((a,b) => String(a).localeCompare(String(b)));

      const days = Array.from(
        new Set(
          allResults
            .map(r => r.day)
            .filter(v => v !== null && v !== undefined && String(v).trim() !== '')
        )
      ).sort((a,b) => Number(a) - Number(b));

      // Tournament options
      tournamentSelect.innerHTML = '<option value="all">All tournaments</option>';
      tournaments.forEach(t => {
        const opt = document.createElement('option');
        opt.value = String(t);
        opt.textContent = String(t);
        tournamentSelect.appendChild(opt);
      });

      // Stage options
      stageSelect.innerHTML = '<option value="all">All stages</option>';
      stages.forEach(st => {
        const opt = document.createElement('option');
        opt.value = String(st);
        opt.textContent = String(st);
        stageSelect.appendChild(opt);
      });

      // Day options
      daySelect.innerHTML = '<option value="all">All days</option>';
      days.forEach(d => {
        const opt = document.createElement('option');
        opt.value = String(d);
        opt.textContent = 'Day ' + d;
        daySelect.appendChild(opt);
      });
    }

    function getFilteredResults(){
      const tournamentVal = tournamentSelect.value;
      const stageVal      = stageSelect.value;
      const dayVal        = daySelect.value;
      const teamQ         = teamInput.value.trim().toLowerCase();

      return allResults.filter(row => {
        if(tournamentVal !== 'all'){
          const t = row.tournament ? String(row.tournament) : '';
          if(t !== tournamentVal) return false;
        }
        if(stageVal !== 'all' && String(row.stage) !== stageVal) return false;
        if(dayVal !== 'all' && String(row.day) !== dayVal) return false;
        if(teamQ){
          const name = (row.team_name || '').toLowerCase();
          if(!name.includes(teamQ)) return false;
        }
        return true;
      });
    }

    function renderSummary(filtered){
      const totalMatches = filtered.length;
      const uniqueTeams = new Set(filtered.map(r => r.team_name || '').filter(Boolean)).size;

      const tournamentVal = tournamentSelect.value;
      const stageVal      = stageSelect.value;
      const dayVal        = daySelect.value;

      let tournamentLabel = 'All tournaments';
      if(tournamentVal !== 'all') tournamentLabel = String(tournamentVal);

      let stageLabel = 'All stages';
      if(stageVal !== 'all') stageLabel = 'Stage ' + stageVal;

      let dayLabel = 'All days';
      if(dayVal !== 'all') dayLabel = 'Day ' + dayVal;

      summaryText.textContent =
        `${totalMatches} match entries • ${uniqueTeams} team(s) • ${tournamentLabel} • ${stageLabel} • ${dayLabel}`;

      // Chips
      summaryChips.innerHTML = '';

      const chipData = [
        { label:'Matches', value: totalMatches },
        { label:'Teams', value: uniqueTeams },
        { label:'Tournament', value: tournamentLabel },
        { label:'Stage', value: stageLabel },
        { label:'Day', value: dayLabel }
      ];

      chipData.forEach(c => {
        const div = document.createElement('div');
        div.className = 'chip';
        div.innerHTML = `${c.label}: <strong>${c.value}</strong>`;
        summaryChips.appendChild(div);
      });
    }

    function renderLeaderboard(filtered){
      leaderboardBody.innerHTML = '';

      if(!filtered.length){
        leaderboardStatus.textContent = 'No data for the current filter.';
        return;
      }

      // Aggregate per team
      const teamMap = new Map();

      filtered.forEach(row => {
        const team = row.team_name || 'Unknown';
        if(!teamMap.has(team)){
          teamMap.set(team, {
            team,
            matches:0,
            booyah:0,
            plc:0,
            elim:0,
            total:0
          });
        }
        const agg = teamMap.get(team);
        agg.matches += 1;

        const victoryVal = row.victory;
        if(victoryVal === true || victoryVal === '1' || victoryVal === 1){
          agg.booyah += 1;
        }

        const plcPts  = Number(row.placement_pts ?? 0);
        const elimPts = Number(row.elimination_pts ?? 0);
        const total   = Number(row.total ?? (plcPts + elimPts));

        agg.plc   += isNaN(plcPts) ? 0 : plcPts;
        agg.elim  += isNaN(elimPts) ? 0 : elimPts;
        agg.total += isNaN(total) ? 0 : total;
      });

      const rows = Array.from(teamMap.values())
        .sort((a,b) => {
          if(b.total !== a.total) return b.total - a.total;
          if(b.booyah !== a.booyah) return b.booyah - a.booyah;
          return a.team.localeCompare(b.team);
        });

      rows.forEach((t, idx) => {
        const tr = document.createElement('tr');

        const tdRank = document.createElement('td');
        tdRank.className = 'rank';
        tdRank.textContent = idx + 1;
        tr.appendChild(tdRank);

        const tdTeam = document.createElement('td');
        tdTeam.className = 'team';
        tdTeam.textContent = t.team;
        tr.appendChild(tdTeam);

        const tdMP = document.createElement('td');
        tdMP.textContent = t.matches;
        tr.appendChild(tdMP);

        const tdBooyah = document.createElement('td');
        tdBooyah.textContent = t.booyah;
        tr.appendChild(tdBooyah);

        const tdPlc = document.createElement('td');
        tdPlc.textContent = t.plc;
        tr.appendChild(tdPlc);

        const tdElim = document.createElement('td');
        tdElim.textContent = t.elim;
        tr.appendChild(tdElim);

        const tdTotal = document.createElement('td');
        tdTotal.className = 'total';
        tdTotal.textContent = t.total;
        tr.appendChild(tdTotal);

        leaderboardBody.appendChild(tr);
      });

      leaderboardStatus.textContent =
        `Showing ${rows.length} team(s). Sorted by Total → Booyah → Team name.`;
    }

    function renderResultsTable(filtered){
      resultsBody.innerHTML = '';

      if(!filtered.length){
        resultsStatus.textContent = 'No match rows for the current filter.';
        return;
      }

      filtered.forEach(row => {
        const tr = document.createElement('tr');

        const tdDay = document.createElement('td');
        tdDay.textContent = row.day ?? '';
        tr.appendChild(tdDay);

        const tdStage = document.createElement('td');
        tdStage.textContent = row.stage ?? '';
        tr.appendChild(tdStage);

        const tdTournament = document.createElement('td');
        tdTournament.textContent = row.tournament ?? '';
        tr.appendChild(tdTournament);

        const tdMatch = document.createElement('td');
        const matchLabel = row.match_no ?? '';
        tdMatch.textContent = matchLabel;
        tr.appendChild(tdMatch);

        const tdSlot = document.createElement('td');
        tdSlot.textContent = row.slot ?? '';
        tr.appendChild(tdSlot);

        const tdTeam = document.createElement('td');
        tdTeam.className = 'team';
        tdTeam.textContent = row.team_name || '';
        tr.appendChild(tdTeam);

        const tdPlacement = document.createElement('td');
        tdPlacement.textContent = row.placement ?? '';
        tr.appendChild(tdPlacement);

        const tdElim = document.createElement('td');
        tdElim.textContent = row.elimination ?? '';
        tr.appendChild(tdElim);

        const tdVictory = document.createElement('td');
        tdVictory.className = 'victory';
        const v = row.victory;
        tdVictory.textContent =
          (v === true || v === 1 || v === '1') ? 'BOOYAH' : '';
        tr.appendChild(tdVictory);

        const tdPlcPts = document.createElement('td');
        tdPlcPts.textContent = row.placement_pts ?? '';
        tr.appendChild(tdPlcPts);

        const tdElimPts = document.createElement('td');
        tdElimPts.textContent = row.elimination_pts ?? '';
        tr.appendChild(tdElimPts);

        const tdTotal = document.createElement('td');
        tdTotal.textContent = row.total ?? '';
        tr.appendChild(tdTotal);

        resultsBody.appendChild(tr);
      });

      resultsStatus.textContent =
        `Showing ${filtered.length} row(s) from match_results.`;
    }

    function applyFiltersAndRender(){
      if(!allResults.length){
        summaryText.textContent = 'No data loaded.';
        leaderboardBody.innerHTML = '';
        resultsBody.innerHTML = '';
        leaderboardStatus.textContent = '';
        resultsStatus.textContent = '';
        return;
      }

      const filtered = getFilteredResults();
      renderSummary(filtered);
      renderLeaderboard(filtered);
      renderResultsTable(filtered);
    }

    // ----- Load data from Supabase -----
    async function loadMatchResults(){
      summaryText.textContent = 'Loading match data from Supabase…';

      try{
        const { data, error } = await client
          .from('match_results')
          .select('*')
          .order('tournament', { ascending:true })
          .order('day', { ascending:true })
          .order('match_no', { ascending:true })
          .order('slot', { ascending:true });

        if(error){
          console.error('Error loading match_results:', error);
          summaryText.textContent = 'Error loading data: ' + error.message;
          leaderboardStatus.textContent = '';
          resultsStatus.textContent = '';
          return;
        }

        allResults = data || [];

        if(!allResults.length){
          summaryText.textContent = 'No rows found in match_results.';
          leaderboardStatus.textContent = 'No data to show.';
          resultsStatus.textContent = 'No data to show.';
          return;
        }

        buildFiltersFromData();
        applyFiltersAndRender();
      }catch(err){
        console.error('Unexpected error loading match_results:', err);
        summaryText.textContent = 'Unexpected error loading data.';
      }
    }

    // ----- Listeners -----
    tournamentSelect.addEventListener('change', applyFiltersAndRender);
    stageSelect.addEventListener('change', applyFiltersAndRender);
    daySelect.addEventListener('change', applyFiltersAndRender);
    teamInput.addEventListener('input', () => {
      if(window.__teamFilterTimer) clearTimeout(window.__teamFilterTimer);
      window.__teamFilterTimer = setTimeout(applyFiltersAndRender, 150);
    });

    // ----- Init -----
    document.addEventListener('DOMContentLoaded', loadMatchResults);
  </script>
</body>
</html>
